<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Classifier</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
    <div class="container">
        <h1>Room Classifier</h1>

        <div class="instructions" id="instructions">
            <div class="step-box">
                <h3>Step 1</h3>
                <p>Wait for the model to load.</p>
            </div>
            <div class="step-box">
                <h3>Step 2</h3>
                <p>Upload a room image.</p>
            </div>
            <div class="step-box">
                <h3>Step 3</h3>
                <p>Review and download your results!</p>
            </div>
        </div>

        <div id="uploadSection">
            <div class="file-input-wrapper">
                <button class="btn">Upload Image</button>
                <input type="file" id="imageUpload" accept="image/*" disabled>
            </div>
            <div id="modelLoading">Loading model, please wait...</div>
        </div>

        <div id="resultSection" class="hidden">
            <img id="uploadedImage" src="" alt="Uploaded Image">
            <div class="result-details">
                <h2>Analysis Results</h2>
                <table id="resultTable">
                    <tr>
                        <th>Room Type</th>
                        <th>Similarity Score</th>
                    </tr>
                </table>
                <button class="download-btn" onclick="downloadResults()">Download Results</button>
                <button class="download-btn" onclick="returnToMain()">Back to Main</button>
            </div>
        </div>

        <a href="https://github.com/your-repo" class="github-icon">
            <img src="github-icon.png" alt="GitHub">
        </a>
    </div>

    <script>
        let model;
        const imageUpload = document.getElementById('imageUpload');
        const instructions = document.getElementById('instructions');
        const uploadSection = document.getElementById('uploadSection');
        const resultSection = document.getElementById('resultSection');
        const uploadedImage = document.getElementById('uploadedImage');
        const modelLoadingText = document.getElementById('modelLoading');
/*
        window.onload = async () => {
            modelLoadingText.style.display = 'block';
            model = await cocoSsd.load();
            modelLoadingText.style.display = 'none';
            imageUpload.disabled = false;
        };*/
        imageUpload.disabled = false;
        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImage.src = e.target.result;
                    uploadedImage.onload = async function() {
                        instructions.style.display = 'none';
                        uploadSection.style.display = 'none';
                        resultSection.classList.remove('hidden');
                        await analyzeImage();
                    }
                }
                reader.readAsDataURL(file);
            }
        });

        function analyzeImage() {
            const fileInput = document.getElementById('imageUpload');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select an image file.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            fetch('/analyze', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                displayResult(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function displayResult(data) {
            const resultTable = document.getElementById('resultTable');
            data.distance_table.forEach(([room, distance]) => {
                const row = resultTable.insertRow();
                row.innerHTML = `<td>${room.split('/').pop().split('_')[0]}</td>
                                <td>${(100 - distance * 10).toFixed(2)}%</td>`;
            });
        }

        function downloadResults() {
            const text = "Results: \n" + document.getElementById('resultTable').innerText;
            const blob = new Blob([text], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'results.txt';
            link.click();
        }

        function returnToMain() {
            resultSection.classList.add('hidden');
            instructions.style.display = 'flex';
            uploadSection.style.display = 'block';
            imageUpload.value = '';
            uploadedImage.src = '';  // 이미지 초기화
            resultTable.innerHTML = `
                <tr>
                    <th>Room Type</th>
                    <th>Similarity Score</th>
                </tr>
            `;  // 결과 테이블 초기화
        }
    </script>
</body>
</html>
